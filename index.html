<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="è‡ªå®¶ç„™ç…ã‚³ãƒ¼ãƒ’ãƒ¼ã®ç„™ç…è¨˜éŒ²ã‚’ç°¡å˜ã«ç®¡ç†ã§ãã‚‹Webã‚¢ãƒ—ãƒªã€‚è±†ã®åå‰ã€æŠ•å…¥æ¸©åº¦ã€ç„™ç…åº¦ã€ã‚¿ã‚¤ãƒãƒ¼ã€æ¸©åº¦ã‚°ãƒ©ãƒ•ãªã©ã‚’è¨˜éŒ²ã—ã€éå»ã®ç„™ç…å±¥æ­´ã¨æ¯”è¼ƒå¯èƒ½ã€‚åˆå¿ƒè€…ã‹ã‚‰ä¸Šç´šè€…ã¾ã§æ´»ç”¨ã§ãã¾ã™ã€‚">

<title>è‡ªå®¶ç„™ç…ã‚³ãƒ¼ãƒ’ãƒ¼è¨˜éŒ²ç®¡ç† | COFFEE ROASTING LOG</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#f3ebe0; display:flex; flex-direction:column; align-items:center; }
footer { 
  font-family: sans-serif;
  width: 100%;
  text-align:center; 
  padding:20px; 
  background:#e8d6c3; /* èƒŒæ™¯è‰²ã‚’å°‘ã—æ¿ƒãã—ã¦ãƒ•ãƒƒã‚¿ãƒ¼æ„Ÿ */
  font-size:10px; 
  color:#4b3f36;
}
footer a { 
  color:#6b4f3c; 
  text-decoration:none; 
  font-weight:500;
}
footer a:hover { text-decoration:underline; }
.container { max-width:900px; width:95%; padding:20px; background:#fff8f0; margin:20px auto; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1,h3 { color:#5a3e2b; text-align:center; }
label { font-weight:bold; color:#5a3e2b; display:flex; flex-direction:column; }
input, button, textarea, select { margin:5px 0; padding:8px; width: 100%; box-sizing: border-box; border-radius:5px; border:1px solid #ccc; }
/* æ—¥ä»˜å…¥åŠ›æ¬„ã®é«˜ã•ã¨èƒŒæ™¯è‰²ã‚’çµ±ä¸€ */
input[type="date"] {
  height: 32.67px;          /* ä»–ã® input ã¨åŒã˜é«˜ã•ã«èª¿æ•´ */
  background-color: #fff; /* ä»–ã® input ã¨åŒã˜èƒŒæ™¯è‰² */
  border: 1px solid #ccc; 
  border-radius: 5px;
  box-sizing: border-box; 
  font-size: 14px;        /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ä»–ã«åˆã‚ã›ã‚‹ */
  color: #000;            /* ãƒ†ã‚­ã‚¹ãƒˆè‰² */
}

/* iOSã§ç°è‰²ã«ãªã‚‹ãƒ•ã‚©ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚’å¼·åˆ¶ */
input[type="date"]::-webkit-datetime-edit {
  color: #000; 
}

/* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚„çŸ¢å°éƒ¨åˆ†ã®èª¿æ•´ */
input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-clear-button {
  -webkit-appearance: none;
  display: none;
}

textarea { height:50px; }
#timerDisplay { font-size:2em; font-weight:bold; margin: 10px 0; text-align:center; color:#d2691e; }
button { cursor:pointer; background:#8b4513; color:white; border:none; border-radius:5px; }
button:hover { background:#a0522d; }
#roastForm { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
#roastForm label { flex:1 1 45%; min-width:200px; }
#timerControls { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-bottom:10px; }
#timerControls button { flex: 1 1 40%; margin:5px; min-width:120px; padding:10px; }
#filters {
    display: flex;
    gap: 10px 15px;
    margin-bottom: 15px;
    align-items: center;
    justify-content: flex-end;
    font-size: small;
}
#filters label {
    display: flow;
    align-items: center;
    gap: 5px;
    font-weight: bold;
    color: #5a3e2b;
}
#filters select {
    width: 55pt;
    font-size: x-small;
    text-align: left ;
}
table { border-collapse: collapse; width: 100%; margin-top:10px; overflow-x:auto; display:block; background:#fff8f0; }
th, td { border: 1px solid #ccc; padding:5px; text-align: center; white-space: nowrap; }
tr:hover { background-color: #f0e6dc; cursor:pointer; }
.temp-chart-container { display: flex; justify-content: center;}
#tempChart { width: 100%;  height:auto; margin-top:10px; background:white; padding:10px; border-radius:8px; box-shadow:0 0 5px #ccc; }
#tempLogDisplay { margin-top:5px; font-size:0.9em; color:#5a3e2b; }

.temp-input-container { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-top: 10px; font-size: small; width: 100%;overflow: auto; white-space: nowrap; box-sizing: border-box; }
.temp-input-container label { font-weight: bold; color: #5a3e2b; min-width: fit-content; text-align: center; }
.temp-input-container input { width: fit-content; font-size: x-small; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
.temp-input-container button { width: 150px; padding: 8px; background-color: #8B4513; color: white; border: none; border-radius: 6px; cursor: pointer; }

#button { display: flex; flex-wrap: wrap; gap: 10pt; justify-content: flex-end; }
#filterBtn, #exportCsvBtn, #addTempBtn { width: 70pt; font-size: x-small; }

.table-container { display: flex; justify-content: center; overflow-x: auto; }
#historyTable {
    border-collapse: collapse;
    width: auto;
    background: #fff8f0;
    font-size: small;
}
#historyTable thead { background-color: #d6bfae; color: #5a3e2b; }
#historyTable th {text-align: center; padding: 5px; border: 1px solid #ccc;
} 
#historyTable td { text-align: left; padding: 5px; border: 1px solid #ccc; }

/* ã‚³ãƒ¡ãƒ³ãƒˆåˆ—ã¯çœç•¥è¡¨ç¤º */
#historyTable th.comment-col,
#historyTable td.comment-col {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
}

/* ãŠæ°—ã«å…¥ã‚Šã‚»ãƒ« */
#historyTable td.favorite-cell { font-size: 18px; color: goldenrod; cursor: pointer; text-align:center; }

/* ç·¨é›†/å‰Šé™¤åˆ—ï¼ˆãŠæ°—ã«å…¥ã‚Šã®å³éš£ï¼‰ */
#historyTable td.operation-col {
    width: fit-content; /* å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ */
    white-space: nowrap;
    text-align: center;
}

/* ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¤ã‚³ãƒ³å½¢å¼ã§å°ã•ã */
.edit-btn, .delete-btn {
    display: inline-block;   /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
    width: 28px;
    height: 28px;
    margin: 0 2px;           /* å·¦å³ã«å°‘ã—ä½™ç™½ */
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
}
.edit-btn { background:#4caf50; color:white; }
.delete-btn { background:#d9534f; color:white; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fff8f0; margin: 6% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.modal-content p { white-space: pre-wrap; word-wrap: break-word; }
.modal-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; color: #5a3e2b; }
.close { color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer; }
.close:hover { color: #000; }

.form-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.form-row label { flex:1; font-weight:normal; }
.form-row input, .form-row textarea { flex:2; }

  /* PRIVACY POLICY ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
  #privacy-modal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.3); /* å°‘ã—é€éå¼±ã‚ */
    justify-content:center;
    align-items:center;
    z-index:1000;
  }
  #privacy-modal .modal-content {
    background:#fdf6f0; /* ã‚µã‚¤ãƒˆã®æŸ”ã‚‰ã‹ã„ãƒ™ãƒ¼ã‚¸ãƒ¥ç³»ã«çµ±ä¸€ */
    padding:25px 30px;
    max-width:600px;
    max-height:80%;
    overflow:auto;
    border-radius:15px; /* è§’ä¸¸ã‚’å¤§ãã‚ã« */
    position:relative;
    box-shadow:0 6px 20px rgba(0,0,0,0.25); /* è»½ã„å½±ã§æµ®ã‹ã›ã‚‹ */
  }
  #privacy-modal .close {
    position:absolute;
    top:12px; right:18px;
    cursor:pointer;
    font-weight:bold;
    font-size:20px;
    color:#4b3f36;
  }
  #privacy-modal h2 { 
    margin-top:0; 
    color:#6b4f3c;
    font-size:22px;
    text-align:center;
  }
    #privacy-modal p { 
    margin-bottom:12px; 
    line-height:1.6; 
    font-size:15px;
    text-align:center; /* ã‚»ãƒ³ã‚¿ãƒ¼å¯„ã› */
  }
  #privacy-modal li { 
    margin-bottom:12px; 
    line-height:1.6; 
    font-size:15px;
  }
  #privacy-modal ol { padding-left:20px; margin:0; }


/* å°å‹ã‚¹ãƒãƒ›ç”¨ */
@media (max-width: 480px) {
  body { font-size: 14px; }
  h1 { font-size: 1.5em; }
  h3 { font-size: 1.2em; }

  #roastForm label { flex: 1 1 100%; }
  #timerControls button { min-width: 70px; font-size: 0.8em; padding: 6px; }
  .temp-input-container { display: flex;  justify-content: flex-start; }
  #button { justify-content: flex-end; }
  #filters { display: flex; flex-direction: row; align-items: center; justify-content:flex-start; gap:10px; overflow-x: auto; white-space: nowrap; padding: 5px 0; box-sizing: border-box;}
  #filters select { width: 50pt; }
  .modal-content { width: 90%; max-width: 90%; }
  .container { width: 85%; padding: 15px; }
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ */
@media (max-width: 768px) {
  #roastForm label { flex: 1 1 100%; }
  #timerControls button { min-width: 100px; }
  .container { width: 90%; padding: 18px; }
}



</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6466859230595575"
     crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
<h1>COFFEE ROASTING LOG</h1>

<h3>åŸºæœ¬æƒ…å ±</h3>
<div id="roastForm">
  <label>è±†ã®åå‰:<input id="beanName" type="text"></label>
  <label>ç„™ç…æ—¥:<input id="roastDate" type="date"></label>
  <label>æŠ•å…¥æ¸©åº¦(â„ƒ):<input id="inputTemp" type="number"></label>
  <label>ç„™ç…å‰é‡é‡(g):<input id="preWeight" type="number"></label>
  <label>ç„™ç…å¾Œé‡é‡(g):<input id="postWeight" type="number" oninput="updateRoastLevel()"></label>
  <label>ç„™ç…åº¦:<input id="roastLevel" type="text" readonly></label>
  <label>ã‚³ãƒ¡ãƒ³ãƒˆ:<textarea id="comment"></textarea></label>
</div>

<h3>ã‚¿ã‚¤ãƒãƒ¼</h3>
<div id="timerDisplay">00:00:00</div>
<div id="timerControls">
  <button id="startBtn">é–‹å§‹</button>
  <button id="pauseBtn">ä¸€æ™‚åœæ­¢</button>
  <button id="firstCrackBtn">1ãƒã‚¼</button>
  <button id="secondCrackBtn">2ãƒã‚¼</button>
  <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ(ã‚¿ã‚¤ãƒãƒ¼/ã‚°ãƒ©ãƒ•)</button>
  <button id="endBtn">çµ‚äº†</button>
  <button id="saveBtn">ç„™ç…è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
</div>

<div class="section">
    <h3>æ¸©åº¦ç®¡ç†</h3>
    <div class="temp-input-container">
      ã€€<label id="historyLabel" >â–  å±¥æ­´å‚ç…§: ãªã—</label>
        <label for="tempInput">â–  æ¸©åº¦:</label>
        <input type="number" id="tempInput" placeholder="æ¸©åº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        <button id="addTempBtn">è¨˜éŒ²</button>
    </div>
<div id="tempLogDisplay"></div>
<div class="temp-chart-container">
<canvas id="tempChart"></canvas>
</div>
</div>

<h3>ç„™ç…è¨˜éŒ²</h3>
<!-- çœç•¥: ä¸Šéƒ¨ã¯ç¾çŠ¶ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ -->
<div id="button">
    <button id="filterBtn">è¨˜éŒ²ã‚’è¡¨ç¤º</button>
    <!-- CSVå‡ºåŠ›ãƒœã‚¿ãƒ³è¿½åŠ  -->
    <button id="exportCsvBtn">CSVå‡ºåŠ›</button>
</div>

<div id="filters">
  <label>è±†ï¼š
    <select id="filterBean"><option value="">ALL</option></select>
  </label>
  <label>ç„™ç…å¹´ï¼š
    <select id="filterYear"><option value="">ALL</option></select>
  </label>
  <label>ç„™ç…æœˆï¼š
    <select id="filterMonth"><option value="">ALL</option></select>
  </label>
  <label>ç„™ç…åº¦ï¼š
    <select id="filterLevel">
      <option value="">ALL</option>
      <option value="æµ…ç…ã‚Š">æµ…ç…ã‚Š</option>
      <option value="ä¸­ç…ã‚Š">ä¸­ç…ã‚Š</option>
      <option value="æ·±ç…ã‚Š">æ·±ç…ã‚Š</option>
    </select>
  </label>
</div>

<div class="table-container">
  <table id="historyTable">
    <thead>
      <tr>
        <th>ãŠæ°—ã«å…¥ã‚Š</th>
        <th class="operation-col">ç·¨é›†/å‰Šé™¤</th> <!-- ã“ã“ã‚’è¿½åŠ  -->
        <th>è±†</th><th>ç„™ç…æ—¥</th><th>æŠ•å…¥æ¸©åº¦(â„ƒ)</th><th>ç„™ç…å‰(g)</th><th>ç„™ç…å¾Œ(g)</th>
        <th>ç„™ç…åº¦</th><th>1ãƒã‚¼</th><th>2ãƒã‚¼</th><th>æ‰€è¦æ™‚é–“</th><th class="comment-col">ã‚³ãƒ¡ãƒ³ãƒˆ(ã‚¯ãƒªãƒƒã‚¯ã§å…¨ä½“ã‚’è¡¨ç¤º)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeCommentModal">&times;</span>
    <div class="modal-title" id="modalTitle"></div>
    <p id="modalText"></p>
  </div>
</div>

<!-- ç·¨é›†ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" id="editClose">&times;</span>
    <h3>ç„™ç…è¨˜éŒ²ã®ç·¨é›†</h3>
    <div class="form-row"><label>è±†å</label><input id="editBean" type="text"></div>
    <div class="form-row"><label>ç„™ç…æ—¥</label><input id="editDate" type="date"></div>
    <div class="form-row"><label>æŠ•å…¥æ¸©åº¦(â„ƒ)</label><input id="editTemp" type="number"></div>
    <div class="form-row"><label>ç„™ç…å‰(g)</label><input id="editPre" type="number" oninput="calcAndUpdateEditRoast()"></div>
    <div class="form-row"><label>ç„™ç…å¾Œ(g)</label><input id="editPost" type="number" oninput="calcAndUpdateEditRoast()"></div>
    <div class="form-row"><label>ç„™ç…åº¦</label><input id="editLevel" type="text" readonly></div>
    <div class="form-row"><label>ã‚³ãƒ¡ãƒ³ãƒˆ</label><textarea id="editComment" rows="4"></textarea></div>
    <div style="text-align:right;"><button id="editSave">ä¿å­˜</button></div>
  </div>
</div>

</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
<footer>
  <a id="privacy-link">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
</footer>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="privacy-modal">
  <div class="modal-content">
    <span class="close" id="close-modal">Ã—</span>
    <h2>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h2>
    <p>å½“ã‚µã‚¤ãƒˆã€ŒCoffee Roasting Logã€ï¼ˆä»¥ä¸‹ã€Œå½“ã‚µã‚¤ãƒˆã€ï¼‰ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’å°Šé‡ã—ã€ä»¥ä¸‹ã®æ–¹é‡ã«åŸºã¥ãé‹å–¶ã—ã¦ã„ã¾ã™ã€‚</p>
    <ol>
      <li>
        <strong>ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã¤ã„ã¦</strong><br>
        å½“ã‚µã‚¤ãƒˆã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹ç„™ç…è¨˜éŒ²ãªã©ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚<br>
        ãã®ãŸã‚ã€å½“ã‚µã‚¤ãƒˆå´ã§å€‹äººæƒ…å ±ã‚„è¨˜éŒ²ã‚’ç®¡ç†ãƒ»åé›†ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
      </li>
      <li>
        <strong>åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã«ã¤ã„ã¦</strong><br>
        å½“ã‚µã‚¤ãƒˆã§ã¯ Google AdSense ç­‰ã®åºƒå‘Šã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<br>
        åºƒå‘Šé…ä¿¡äº‹æ¥­è€…ã¯ Cookie ç­‰ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«åŸºã¥ã„ãŸåºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
        ã¾ãŸã€å½“ã‚µã‚¤ãƒˆã¯ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å‚åŠ ã—ã¦ãŠã‚Šã€ãƒªãƒ³ã‚¯å…ˆã®å•†å“è³¼å…¥ã«ã‚ˆã‚Šå ±é…¬ã‚’å¾—ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
        åºƒå‘Šã‚„ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã«ã‚ˆã‚Šåé›†ã•ã‚Œã‚‹æƒ…å ±ã¯ã€å„ã‚µãƒ¼ãƒ“ã‚¹æä¾›è€…ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«å¾“ã„ã¾ã™ã€‚
      </li>
      <li>
        <strong>ã‚¯ãƒƒã‚­ãƒ¼ã«ã¤ã„ã¦</strong><br>
        å½“ã‚µã‚¤ãƒˆã§ã¯ã€åºƒå‘Šè¡¨ç¤ºã‚„ã‚¢ã‚¯ã‚»ã‚¹è§£æã®ãŸã‚ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
        ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã«ã‚ˆã‚Šã‚¯ãƒƒã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
      </li>
      <li>
        <strong>æ”¹å®šã«ã¤ã„ã¦</strong><br>
        æœ¬ãƒãƒªã‚·ãƒ¼ã¯éšæ™‚æ”¹å®šã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
        æ”¹å®šå¾Œã¯å½“ã‚µã‚¤ãƒˆä¸Šã«æ²è¼‰ã—ã¾ã™ã€‚
      </li>
    </ol>
    <p><strong>ã€ãŠå•ã„åˆã‚ã›ã€‘</strong><br>coffeegeek0809@gmail.com</p>
  </div>
</div>

<script>
  const modal = document.getElementById('privacy-modal');
  document.getElementById('privacy-link').onclick = () => {
    modal.style.display = 'flex';
  }
  document.getElementById('close-modal').onclick = () => {
    modal.style.display = 'none';
  }
  window.onclick = (e) => {
    if(e.target == modal) modal.style.display = 'none';
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let roastTimer=0, timerInterval=null;
  let temperatureLog=[], firstCrackTimes=[], secondCrackTimes=[], roastEndTime=null;
  let chart=null, historyLog=null;
  let editingId = null; // ç·¨é›†å¯¾è±¡ã® id

  function secToHMS(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function displayTimer(sec){ document.getElementById("timerDisplay").innerText = secToHMS(sec); }

  window.updateRoastLevel = function(){
    const pre=parseFloat(document.getElementById("preWeight").value);
    const post=parseFloat(document.getElementById("postWeight").value);
    if(pre>0 && post>0){
      const index=pre/post;
      let level="";
      if(index<1.15) level="æµ…ç…ã‚Š";
      else if(index<1.2) level="ä¸­ç…ã‚Š";
      else level="æ·±ç…ã‚Š";
      document.getElementById("roastLevel").value=`${level}ï¼ˆ${index.toFixed(3)}ï¼‰`;
    }
  }

  // --- data sanity: ä¸å®Œå…¨ãªæ—¢å­˜ãƒ­ã‚°ã‚’è£œå®Œ ---
  function ensureLogSanity(){
    const logs = JSON.parse(localStorage.getItem("roastLogs"))||[];
    let changed = false;
    for(let i=0;i<logs.length;i++){
      const l = logs[i];
      if(!l.id){ l.id = Date.now().toString() + '-' + Math.random().toString(36).slice(2,8); changed = true; }
      if(typeof l.favorite === 'undefined'){ l.favorite = false; changed = true; }
      if(!Array.isArray(l.temperatureLog)) { l.temperatureLog = l.temperatureLog || []; changed = true; }
      if(!Array.isArray(l.firstCrackTimes)) { l.firstCrackTimes = l.firstCrackTimes || []; changed = true; }
      if(!Array.isArray(l.secondCrackTimes)) { l.secondCrackTimes = l.secondCrackTimes || []; changed = true; }
      if(typeof l.roastEndTime === 'undefined') { l.roastEndTime = l.roastEndTime ?? null; changed = true; }
    }
    if(changed) localStorage.setItem("roastLogs", JSON.stringify(logs));
  }

  function populateFilterOptions(){
    ensureLogSanity();
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const beanSet=new Set(), yearSet=new Set(), monthSet=new Set();
    logs.forEach(log=>{
      beanSet.add(log.beanName);
      const d=new Date(log.roastDate);
      if(!isNaN(d)) {
        yearSet.add(d.getFullYear());
        monthSet.add(d.getMonth()+1);
      }
    });
    const beanSelect=document.getElementById("filterBean");
    const yearSelect=document.getElementById("filterYear");
    const monthSelect=document.getElementById("filterMonth");
    // ã„ã£ãŸã‚“ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰è¿½åŠ ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    beanSelect.innerHTML = '<option value="">ALL</option>';
    yearSelect.innerHTML = '<option value="">ALL</option>';
    monthSelect.innerHTML = '<option value="">ALL</option>';
    Array.from(beanSet).sort().forEach(b=>{
      const opt=document.createElement("option");
      opt.value=b; opt.text=b; beanSelect.add(opt);
    });
    Array.from(yearSet).sort().forEach(y=>{
      const opt=document.createElement("option");
      opt.value=y; opt.text=y; yearSelect.add(opt);
    });
    Array.from(monthSet).sort().forEach(m=>{
      const opt=document.createElement("option");
      opt.value=m; opt.text=m; monthSelect.add(opt);
    });
  }

  // --- è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼‰ ---
  function displayHistory(){
    ensureLogSanity();
    const tbody=document.querySelector("#historyTable tbody");
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const beanFilter=document.getElementById("filterBean").value;
    const yearFilter=document.getElementById("filterYear").value;
    const monthFilter=document.getElementById("filterMonth").value;
    const levelFilter=document.getElementById("filterLevel").value;

    const filteredLogs=logs.filter(log=>{
      const d=new Date(log.roastDate);
      const roastYear=d.getFullYear();
      const roastMonth=d.getMonth()+1;
      const roastLevel=log.roastLevel?log.roastLevel.split("ï¼ˆ")[0]:"";
      if(beanFilter && log.beanName!==beanFilter) return false;
      if(yearFilter && roastYear!==parseInt(yearFilter)) return false;
      if(monthFilter && roastMonth!==parseInt(monthFilter)) return false;
      if(levelFilter && roastLevel!==levelFilter) return false;
      return true;
    });

    tbody.innerHTML="";
    filteredLogs.forEach((log)=>{
      const tr=document.createElement("tr");
      const star = log.favorite ? "â˜…" : "â˜†";
      tr.innerHTML=`
        <td class="favorite-cell" data-id="${log.id}">${star}</td>
        <td class="operation-col">
          <button class="edit-btn" data-id="${log.id}" title="ç·¨é›†">âœ</button>
          <button class="delete-btn" data-id="${log.id}" title="å‰Šé™¤">ğŸ—‘</button>
        </td>
        <td>${log.beanName}</td>
        <td>${log.roastDate}</td>
        <td>${log.inputTemp ?? ''}</td>
        <td>${log.preWeight ?? ''}</td>
        <td>${log.postWeight ?? ''}</td>
        <td>${log.roastLevel ?? ''}</td>
        <td>${(log.firstCrackTimes||[]).map(secToHMS).join(', ')}</td>
        <td>${(log.secondCrackTimes||[]).map(secToHMS).join(', ')}</td>
        <td>${log.roastEndTime!==null && log.roastEndTime!==undefined?secToHMS(log.roastEndTime):''}</td>
        <td class="comment-col">${log.comment ?? ''}</td>
      `;
      tr.addEventListener('click', ()=>{ historyLog = log; document.getElementById("historyLabel").innerText = "â–  å±¥æ­´å‚ç…§ä¸­: " + log.beanName + " / " + log.roastDate; updateChart(); });
      tbody.appendChild(tr);
    });

    // --- attach events for newly created elements ---

    // ãŠæ°—ã«å…¥ã‚Šåˆ‡æ›¿
    document.querySelectorAll(".favorite-cell").forEach(cell=>{
      cell.addEventListener("click",(e)=>{
        e.stopPropagation();
        const id = cell.dataset.id;
        const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
        const idxAll = logsAll.findIndex(l=>l.id === id);
        if(idxAll>=0){
          logsAll[idxAll].favorite = !logsAll[idxAll].favorite;
          localStorage.setItem("roastLogs", JSON.stringify(logsAll));
          populateFilterOptions();
          displayHistory();
        }
      });
    });

    // ã‚³ãƒ¡ãƒ³ãƒˆåˆ—ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«
    document.querySelectorAll("#historyTable td.comment-col").forEach(td=>{
      td.addEventListener("click",(e)=>{
        e.stopPropagation();
        const tr = td.parentElement;
        const bean = tr.cells[2].innerText;
        const date = tr.cells[3].innerText;
        const level = tr.cells[7].innerText;
        document.getElementById("modalText").innerText = td.innerText;
        document.getElementById("modalTitle").innerText = `${bean} / ${date} / ${level}`;
        document.getElementById("commentModal").style.display = "block";
      });
    });

    // ç·¨é›†ãƒœã‚¿ãƒ³
    document.querySelectorAll(".edit-btn").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        const id = btn.dataset.id;
        const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
        const idxAll = logsAll.findIndex(l=>l.id === id);
        if(idxAll<0) return;
        const record = logsAll[idxAll];
        editingId = id;
        document.getElementById("editBean").value = record.beanName || "";
        document.getElementById("editDate").value = record.roastDate || "";
        document.getElementById("editTemp").value = record.inputTemp ?? "";
        document.getElementById("editPre").value = record.preWeight ?? "";
        document.getElementById("editPost").value = record.postWeight ?? "";
        document.getElementById("editLevel").value = record.roastLevel || "";
        document.getElementById("editComment").value = record.comment || "";
        document.getElementById("editModal").style.display = "block";
      });
    });

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        const id = btn.dataset.id;
        if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
        const idxAll = logsAll.findIndex(l=>l.id === id);
        if(idxAll>=0){
          logsAll.splice(idxAll,1);
          localStorage.setItem("roastLogs", JSON.stringify(logsAll));
          populateFilterOptions();
          displayHistory();
        }
      });
    });

  } // displayHistory end

  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šé–‰ã˜ã‚‹ï¼ˆå…±é€šï¼‰ ---
  document.getElementById("closeCommentModal").addEventListener("click", ()=>{ document.getElementById("commentModal").style.display = "none"; });
  document.getElementById("editClose").addEventListener("click", ()=>{ document.getElementById("editModal").style.display = "none"; });

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆä¸¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å¯¾å¿œï¼‰
  window.addEventListener("click", (event)=>{
    const cm = document.getElementById("commentModal");
    const em = document.getElementById("editModal");
    if(event.target === cm) cm.style.display = "none";
    if(event.target === em) em.style.display = "none";
  });

// å…±é€šè¨ˆç®—ï¼†æ›´æ–°é–¢æ•°
function calcAndUpdateEditRoast() {
  const pre = parseFloat(document.getElementById("editPre").value);
  const post = parseFloat(document.getElementById("editPost").value);

  if(pre > 0 && post > 0){
    const roastIndex = pre / post;
    let roastLevel = "";
    if(roastIndex < 1.15) roastLevel = "æµ…ç…ã‚Š";
    else if(roastIndex < 1.2) roastLevel = "ä¸­ç…ã‚Š";
    else roastLevel = "æ·±ç…ã‚Š";

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨
    document.getElementById("editLevel").value = `${roastLevel}ï¼ˆ${roastIndex.toFixed(3)}ï¼‰`;

    return { roastIndex, roastLevel: `${roastLevel}ï¼ˆ${roastIndex.toFixed(3)}ï¼‰` };
  } else {
    document.getElementById("editLevel").value = "";
    return { roastIndex: null, roastLevel: "" };
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›æ¬„ã®oninputã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
document.getElementById("editPre").addEventListener("input", calcAndUpdateEditRoast);
document.getElementById("editPost").addEventListener("input", calcAndUpdateEditRoast);

// ä¿å­˜ãƒœã‚¿ãƒ³å‡¦ç†
document.getElementById("editSave").addEventListener("click", ()=> {
  if(!editingId){ alert("ç·¨é›†å¯¾è±¡ãŒä¸æ˜ã§ã™"); return; }
  const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
  const idxAll = logsAll.findIndex(l=>l.id === editingId);
  if(idxAll<0){ alert("å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

  const pre = parseFloat(document.getElementById("editPre").value);
  const post = parseFloat(document.getElementById("editPost").value);

  // è¨ˆç®—é–¢æ•°ã§ç„™ç…æŒ‡æ•°ã¨åº¦åˆã‚’å–å¾—
  const { roastIndex, roastLevel } = calcAndUpdateEditRoast();

  // ä¿å­˜
  logsAll[idxAll] = {
    ...logsAll[idxAll],
    beanName: document.getElementById("editBean").value,
    roastDate: document.getElementById("editDate").value,
    inputTemp: parseFloat(document.getElementById("editTemp").value) || null,
    preWeight: pre || null,
    postWeight: post || null,
    roastIndex,
    roastLevel,
    comment: document.getElementById("editComment").value
  };

  localStorage.setItem("roastLogs", JSON.stringify(logsAll));
  populateFilterOptions();
  displayHistory();
  document.getElementById("editModal").style.display = "none";
});



  // --- æ—¢å­˜ã®å‡¦ç†ï¼ˆã‚¿ã‚¤ãƒãƒ¼ãƒ»è¨˜éŒ²è¿½åŠ ç­‰ï¼‰ ---
  function startTimer(){
    temperatureLog = [];
    firstCrackTimes = [];
    secondCrackTimes = [];
    roastEndTime = null;
    roastTimer = 0;
    displayTimer(roastTimer);
    updateTempLogDisplay();
    updateChart();
    const inputTemp = parseFloat(document.getElementById("inputTemp").value);
    if(!isNaN(inputTemp)) temperatureLog.push({time:roastTimer,temp:inputTemp,label:"æŠ•å…¥"});
    if(timerInterval) return;
    timerInterval=setInterval(()=>{ roastTimer++; displayTimer(roastTimer); },1000);
  }
  function pauseTimer(){ clearInterval(timerInterval); timerInterval=null; }
  function resetTimer(){ clearInterval(timerInterval); roastTimer=0; temperatureLog=[]; firstCrackTimes=[]; secondCrackTimes=[]; roastEndTime=null; displayTimer(0); updateTempLogDisplay(); updateChart(); }
  function endTimer(){ pauseTimer(); roastEndTime=roastTimer; const temp=parseFloat(prompt("çµ‚äº†æ™‚ã®æ¸©åº¦(â„ƒ)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"çµ‚äº†"}); updateTempLogDisplay(); updateChart(); }
  function markFirstCrack(){ const temp=parseFloat(prompt("1ãƒã‚¼æ™‚ã®æ¸©åº¦(â„ƒ)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"1ãƒã‚¼"}); firstCrackTimes.push(roastTimer); updateTempLogDisplay(); updateChart(); }
  function markSecondCrack(){ const temp=parseFloat(prompt("2ãƒã‚¼æ™‚ã®æ¸©åº¦(â„ƒ)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"2ãƒã‚¼"}); secondCrackTimes.push(roastTimer); updateTempLogDisplay(); updateChart(); }

  function addTemperature() {
    const temp = parseFloat(document.getElementById("tempInput").value);
    if(!isNaN(temp)){
      temperatureLog.push({time: roastTimer, temp, label: "æ‰‹å‹•"});
      document.getElementById("tempInput").value = "";
      updateTempLogDisplay();
      updateChart();
    }
  }

  function updateTempLogDisplay(){
    document.getElementById("tempLogDisplay").innerText=
      temperatureLog.map(t=>t.label?`${secToHMS(t.time)}:${t.temp}â„ƒ (${t.label})`:`${secToHMS(t.time)}:${t.temp}â„ƒ`).join(', ');
  }

  function updateChart(){
    const ctx=document.getElementById("tempChart").getContext('2d');
    if(chart) chart.destroy();

    const currentData = temperatureLog.map(t=>({x:t.time,y:t.temp}));
    let datasets=[{
      label:'ä»Šå›ã®ç„™ç…',
      data: currentData,
      borderColor:'#a67c52',
      backgroundColor:'rgba(166,124,82,0.2)',
      tension:0.1,
      parsing:false,
      pointBackgroundColor: temperatureLog.map(t=>{
        if(t.label==='æŠ•å…¥') return '#8b4513';
        if(t.label==='1ãƒã‚¼') return 'green';
        if(t.label==='2ãƒã‚¼') return 'blue';
        if(t.label==='çµ‚äº†') return '#5a3e2b';
        return '#a67c52';
      })
    }];

    if(historyLog && Array.isArray(historyLog.temperatureLog)){
      const historyData = historyLog.temperatureLog.map(t=>({x:t.time,y:t.temp}));
      datasets.push({
        label:'æ¯”è¼ƒå¯¾è±¡ã®ç„™ç…',
        data: historyData,
        borderColor:'#ccc',
        backgroundColor:'rgba(200,200,200,0.2)',
        tension:0.1,
        parsing:false,
        pointRadius:2
      });
    }

    let annotations={};
    firstCrackTimes.forEach((t,i)=>{ annotations['f'+i]={type:'line', scaleID:'x', value:t, borderColor:'green', borderWidth:2,label:{display:true, content:'1ãƒã‚¼', color:'#fff', backgroundColor:'green', position:'start', rotation:0}}; });
    secondCrackTimes.forEach((t,i)=>{ annotations['s'+i]={type:'line', scaleID:'x', value:t, borderColor:'blue', borderWidth:2,label:{display:true, content:'2ãƒã‚¼', color:'#fff', backgroundColor:'blue', position:'start', rotation:0}}; });
    if(roastEndTime!==null) annotations['end']={type:'line', scaleID:'x', value:roastEndTime, borderColor:'#5a3e2b', borderWidth:2,label:{display:true, content:'çµ‚äº†', color:'#fff', backgroundColor:'#5a3e2b', position:'start', rotation:0}};
    if(historyLog){
      (historyLog.firstCrackTimes||[]).forEach((t,i)=>{ annotations['hf'+i]={type:'line', scaleID:'x', value:t, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'1ãƒã‚¼', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}}; });
      (historyLog.secondCrackTimes||[]).forEach((t,i)=>{ annotations['hs'+i]={type:'line', scaleID:'x', value:t, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'2ãƒã‚¼', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}}; });
      if(historyLog.roastEndTime!==null) annotations['hend']={type:'line', scaleID:'x', value:historyLog.roastEndTime, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'çµ‚äº†', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}};
    }

    chart=new Chart(ctx,{
      type:'line',
      data:{datasets},
      options:{
        scales:{ x:{ type:'linear', title:{display:true,text:'æ™‚é–“'} }, y:{ title:{display:true,text:'æ¸©åº¦(â„ƒ)'} } },
        plugins:{ legend:{ display:true }, annotation:{ annotations } }
      }
    });
  }

  // ä¿å­˜æ™‚ã«ä¸€æ„ã® id ã¨ favorite ã‚’ä»˜ä¸ã—ã¦ä¿å­˜ï¼ˆæ¸©åº¦ãƒ­ã‚°ç­‰ã¯ deep copyï¼‰
  function saveRoast(){
    const beanName=document.getElementById("beanName").value;
    const roastDate=document.getElementById("roastDate").value;
    const inputTemp=parseFloat(document.getElementById("inputTemp").value);
    const preWeight=parseFloat(document.getElementById("preWeight").value);
    const postWeight=parseFloat(document.getElementById("postWeight").value);
    const roastLevel=document.getElementById("roastLevel").value;
    const comment=document.getElementById("comment").value;
    if(!beanName || !roastDate || !preWeight || !postWeight){ alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const roastIndex=preWeight/postWeight;
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const newId = Date.now().toString() + '-' + Math.random().toString(36).slice(2,8);
    // deep copy for arrays so later edits don't mutate saved record's arrays via reference
    const tempLogCopy = JSON.parse(JSON.stringify(temperatureLog || []));
    const fctCopy = JSON.parse(JSON.stringify(firstCrackTimes || []));
    const sctCopy = JSON.parse(JSON.stringify(secondCrackTimes || []));
    logs.push({
      id: newId,
      beanName, roastDate, inputTemp, preWeight, postWeight, roastIndex, roastLevel, comment,
      temperatureLog: tempLogCopy, firstCrackTimes: fctCopy, secondCrackTimes: sctCopy, roastEndTime,
      favorite: false
    });
    localStorage.setItem("roastLogs",JSON.stringify(logs));
    populateFilterOptions();
    displayHistory();
    alert("ä¿å­˜ã—ã¾ã—ãŸ");
  }

  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆè¡¨ç¤ºå®‰å…¨ï¼‰
  function escapeHtml(str){
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  document.getElementById("startBtn").addEventListener("click", startTimer);
  document.getElementById("pauseBtn").addEventListener("click", pauseTimer);
  document.getElementById("resetBtn").addEventListener("click", resetTimer);
  document.getElementById("firstCrackBtn").addEventListener("click", markFirstCrack);
  document.getElementById("secondCrackBtn").addEventListener("click", markSecondCrack);
  document.getElementById("endBtn").addEventListener("click", endTimer);
  document.getElementById("addTempBtn").addEventListener("click", addTemperature);
  document.getElementById("saveBtn").addEventListener("click", saveRoast);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
  document.getElementById("filterBtn").addEventListener("click", displayHistory);

  // åˆæœŸåŒ–
  populateFilterOptions();
  //ã€€displayHistory(); // åˆå›è¡¨ç¤ºï¼ˆä¸è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ï¼‰

// DOMContentLoaded å†…ã«è¿½åŠ 

// CSVå‡ºåŠ›é–¢æ•°
function exportCSV() {
  const logs = JSON.parse(localStorage.getItem("roastLogs")) || [];
  if(logs.length === 0){ alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

  const headers = ["ãŠæ°—ã«å…¥ã‚Š","è±†å","ç„™ç…æ—¥","ç„™ç…åº¦","ç„™ç…å‰é‡é‡","ç„™ç…å¾Œé‡é‡","æŠ•å…¥æ¸©åº¦","1ãƒã‚¼","2ãƒã‚¼","çµ‚äº†æ™‚é–“","æ¸©åº¦ãƒ­ã‚°","ã‚³ãƒ¡ãƒ³ãƒˆ"];
  
  const rows = logs.map(log => {
    const firstCrack = (log.firstCrackTimes||[]).map(formatMMSS).join(";");
    const secondCrack = (log.secondCrackTimes||[]).map(formatMMSS).join(";");
    const tempLog = (log.temperatureLog||[])
      .map(t => `${formatMMSS(t.time)}:${t.temp}â„ƒ${t.label?`(${t.label})`:''}`)
      .join(", ");
    return [
      log.favorite?"â˜…":"â˜†",
      log.beanName || "",
      log.roastDate || "",
      log.roastLevel || "",
      log.preWeight ?? "",
      log.postWeight ?? "",
      log.inputTemp ?? "",
      firstCrack,
      secondCrack,
      log.roastEndTime!==null && log.roastEndTime!==undefined ? formatMMSS(log.roastEndTime) : '',
      tempLog,
      log.comment ?? ""
    ].map(v => `"${v}"`).join(",");
  });

  const bom = "\uFEFF";
  const csvContent = bom + [headers.join(","), ...rows].join("\r\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  a.download = `roast_log_${yyyy}-${mm}-${dd}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}


// ç§’ã‚’ mm:ss ã«å¤‰æ›
function formatMMSS(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// CSVå‡ºåŠ›ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);


}); // DOMContentLoaded end
</script>
</body>
</html>

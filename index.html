<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="自家焙煎コーヒーの焙煎記録を簡単に管理できるWebアプリ。豆の名前、投入温度、焙煎度、タイマー、温度グラフなどを記録し、過去の焙煎履歴と比較可能。初心者から上級者まで活用できます。">

<title>自家焙煎コーヒー記録管理 | COFFEE ROASTING LOG</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#f3ebe0; display:flex; flex-direction:column; align-items:center; }
footer { 
  font-family: sans-serif;
  width: 100%;
  text-align:center; 
  padding:20px; 
  background:#e8d6c3; /* 背景色を少し濃くしてフッター感 */
  font-size:10px; 
  color:#4b3f36;
}
footer a { 
  color:#6b4f3c; 
  text-decoration:none; 
  font-weight:500;
}
footer a:hover { text-decoration:underline; }
.container { max-width:900px; width:95%; padding:20px; background:#fff8f0; margin:20px auto; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1,h3 { color:#5a3e2b; text-align:center; }
label { font-weight:bold; color:#5a3e2b; display:flex; flex-direction:column; }
input, button, textarea, select { margin:5px 0; padding:8px; width: 100%; box-sizing: border-box; border-radius:5px; border:1px solid #ccc; }
/* 日付入力欄の高さと背景色を統一 */
input[type="date"] {
  height: 32.67px;          /* 他の input と同じ高さに調整 */
  background-color: #fff; /* 他の input と同じ背景色 */
  border: 1px solid #ccc; 
  border-radius: 5px;
  box-sizing: border-box; 
  font-size: 14px;        /* フォントサイズを他に合わせる */
  color: #000;            /* テキスト色 */
}

/* iOSで灰色になるフォントカラーを強制 */
input[type="date"]::-webkit-datetime-edit {
  color: #000; 
}

/* プレースホルダや矢印部分の調整 */
input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-clear-button {
  -webkit-appearance: none;
  display: none;
}

textarea { height:50px; }
#timerDisplay { font-size:2em; font-weight:bold; margin: 10px 0; text-align:center; color:#d2691e; }
button { cursor:pointer; background:#8b4513; color:white; border:none; border-radius:5px; }
button:hover { background:#a0522d; }
#roastForm { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
#roastForm label { flex:1 1 45%; min-width:200px; }
#timerControls { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-bottom:10px; }
#timerControls button { flex: 1 1 40%; margin:5px; min-width:120px; padding:10px; }
#filters {
    display: flex;
    gap: 10px 15px;
    margin-bottom: 15px;
    align-items: center;
    justify-content: flex-end;
    font-size: small;
}
#filters label {
    display: flow;
    align-items: center;
    gap: 5px;
    font-weight: bold;
    color: #5a3e2b;
}
#filters select {
    width: 55pt;
    font-size: x-small;
    text-align: left ;
}
table { border-collapse: collapse; width: 100%; margin-top:10px; overflow-x:auto; display:block; background:#fff8f0; }
th, td { border: 1px solid #ccc; padding:5px; text-align: center; white-space: nowrap; }
tr:hover { background-color: #f0e6dc; cursor:pointer; }
.temp-chart-container { display: flex; justify-content: center;}
#tempChart { width: 100%;  height:auto; margin-top:10px; background:white; padding:10px; border-radius:8px; box-shadow:0 0 5px #ccc; }
#tempLogDisplay { margin-top:5px; font-size:0.9em; color:#5a3e2b; }

.temp-input-container { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-top: 10px; font-size: small; width: 100%;overflow: auto; white-space: nowrap; box-sizing: border-box; }
.temp-input-container label { font-weight: bold; color: #5a3e2b; min-width: fit-content; text-align: center; }
.temp-input-container input { width: fit-content; font-size: x-small; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
.temp-input-container button { width: 150px; padding: 8px; background-color: #8B4513; color: white; border: none; border-radius: 6px; cursor: pointer; }

#button { display: flex; flex-wrap: wrap; gap: 10pt; justify-content: flex-end; }
#filterBtn, #exportCsvBtn, #addTempBtn { width: 70pt; font-size: x-small; }

.table-container { display: flex; justify-content: center; overflow-x: auto; }
#historyTable {
    border-collapse: collapse;
    width: auto;
    background: #fff8f0;
    font-size: small;
}
#historyTable thead { background-color: #d6bfae; color: #5a3e2b; }
#historyTable th {text-align: center; padding: 5px; border: 1px solid #ccc;
} 
#historyTable td { text-align: left; padding: 5px; border: 1px solid #ccc; }

/* コメント列は省略表示 */
#historyTable th.comment-col,
#historyTable td.comment-col {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
}

/* お気に入りセル */
#historyTable td.favorite-cell { font-size: 18px; color: goldenrod; cursor: pointer; text-align:center; }

/* 編集/削除列（お気に入りの右隣） */
#historyTable td.operation-col {
    width: fit-content; /* 必要に応じて調整 */
    white-space: nowrap;
    text-align: center;
}

/* 編集・削除ボタンをアイコン形式で小さく */
.edit-btn, .delete-btn {
    display: inline-block;   /* 横並びにする */
    width: 28px;
    height: 28px;
    margin: 0 2px;           /* 左右に少し余白 */
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
}
.edit-btn { background:#4caf50; color:white; }
.delete-btn { background:#d9534f; color:white; }

/* モーダル */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fff8f0; margin: 6% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.modal-content p { white-space: pre-wrap; word-wrap: break-word; }
.modal-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; color: #5a3e2b; }
.close { color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer; }
.close:hover { color: #000; }

.form-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.form-row label { flex:1; font-weight:normal; }
.form-row input, .form-row textarea { flex:2; }

  /* PRIVACY POLICY モーダルスタイル */
  #privacy-modal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.3); /* 少し透過弱め */
    justify-content:center;
    align-items:center;
    z-index:1000;
  }
  #privacy-modal .modal-content {
    background:#fdf6f0; /* サイトの柔らかいベージュ系に統一 */
    padding:25px 30px;
    max-width:600px;
    max-height:80%;
    overflow:auto;
    border-radius:15px; /* 角丸を大きめに */
    position:relative;
    box-shadow:0 6px 20px rgba(0,0,0,0.25); /* 軽い影で浮かせる */
  }
  #privacy-modal .close {
    position:absolute;
    top:12px; right:18px;
    cursor:pointer;
    font-weight:bold;
    font-size:20px;
    color:#4b3f36;
  }
  #privacy-modal h2 { 
    margin-top:0; 
    color:#6b4f3c;
    font-size:22px;
    text-align:center;
  }
    #privacy-modal p { 
    margin-bottom:12px; 
    line-height:1.6; 
    font-size:15px;
    text-align:center; /* センター寄せ */
  }
  #privacy-modal li { 
    margin-bottom:12px; 
    line-height:1.6; 
    font-size:15px;
  }
  #privacy-modal ol { padding-left:20px; margin:0; }


/* 小型スマホ用 */
@media (max-width: 480px) {
  body { font-size: 14px; }
  h1 { font-size: 1.5em; }
  h3 { font-size: 1.2em; }

  #roastForm label { flex: 1 1 100%; }
  #timerControls button { min-width: 70px; font-size: 0.8em; padding: 6px; }
  .temp-input-container { display: flex;  justify-content: flex-start; }
  #button { justify-content: flex-end; }
  #filters { display: flex; flex-direction: row; align-items: center; justify-content:flex-start; gap:10px; overflow-x: auto; white-space: nowrap; padding: 5px 0; box-sizing: border-box;}
  #filters select { width: 50pt; }
  .modal-content { width: 90%; max-width: 90%; }
  .container { width: 85%; padding: 15px; }
}

/* タブレット用 */
@media (max-width: 768px) {
  #roastForm label { flex: 1 1 100%; }
  #timerControls button { min-width: 100px; }
  .container { width: 90%; padding: 18px; }
}



</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6466859230595575"
     crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
<h1>COFFEE ROASTING LOG</h1>

<h3>基本情報</h3>
<div id="roastForm">
  <label>豆の名前:<input id="beanName" type="text"></label>
  <label>焙煎日:<input id="roastDate" type="date"></label>
  <label>投入温度(℃):<input id="inputTemp" type="number"></label>
  <label>焙煎前重量(g):<input id="preWeight" type="number"></label>
  <label>焙煎後重量(g):<input id="postWeight" type="number" oninput="updateRoastLevel()"></label>
  <label>焙煎度:<input id="roastLevel" type="text" readonly></label>
  <label>コメント:<textarea id="comment"></textarea></label>
</div>

<h3>タイマー</h3>
<div id="timerDisplay">00:00:00</div>
<div id="timerControls">
  <button id="startBtn">開始</button>
  <button id="pauseBtn">一時停止</button>
  <button id="firstCrackBtn">1ハゼ</button>
  <button id="secondCrackBtn">2ハゼ</button>
  <button id="resetBtn">リセット(タイマー/グラフ)</button>
  <button id="endBtn">終了</button>
  <button id="saveBtn">焙煎記録を保存する</button>
</div>

<div class="section">
    <h3>温度管理</h3>
    <div class="temp-input-container">
      　<label id="historyLabel" >■ 履歴参照: なし</label>
        <label for="tempInput">■ 温度:</label>
        <input type="number" id="tempInput" placeholder="温度を入力してください">
        <button id="addTempBtn">記録</button>
    </div>
<div id="tempLogDisplay"></div>
<div class="temp-chart-container">
<canvas id="tempChart"></canvas>
</div>
</div>

<h3>焙煎記録</h3>
<!-- 省略: 上部は現状コードと同じ -->
<div id="button">
    <button id="filterBtn">記録を表示</button>
    <!-- CSV出力ボタン追加 -->
    <button id="exportCsvBtn">CSV出力</button>
</div>

<div id="filters">
  <label>豆：
    <select id="filterBean"><option value="">ALL</option></select>
  </label>
  <label>焙煎年：
    <select id="filterYear"><option value="">ALL</option></select>
  </label>
  <label>焙煎月：
    <select id="filterMonth"><option value="">ALL</option></select>
  </label>
  <label>焙煎度：
    <select id="filterLevel">
      <option value="">ALL</option>
      <option value="浅煎り">浅煎り</option>
      <option value="中煎り">中煎り</option>
      <option value="深煎り">深煎り</option>
    </select>
  </label>
</div>

<div class="table-container">
  <table id="historyTable">
    <thead>
      <tr>
        <th>お気に入り</th>
        <th class="operation-col">編集/削除</th> <!-- ここを追加 -->
        <th>豆</th><th>焙煎日</th><th>投入温度(℃)</th><th>焙煎前(g)</th><th>焙煎後(g)</th>
        <th>焙煎度</th><th>1ハゼ</th><th>2ハゼ</th><th>所要時間</th><th class="comment-col">コメント(クリックで全体を表示)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- コメント表示用モーダル -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeCommentModal">&times;</span>
    <div class="modal-title" id="modalTitle"></div>
    <p id="modalText"></p>
  </div>
</div>

<!-- 編集用モーダル -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" id="editClose">&times;</span>
    <h3>焙煎記録の編集</h3>
    <div class="form-row"><label>豆名</label><input id="editBean" type="text"></div>
    <div class="form-row"><label>焙煎日</label><input id="editDate" type="date"></div>
    <div class="form-row"><label>投入温度(℃)</label><input id="editTemp" type="number"></div>
    <div class="form-row"><label>焙煎前(g)</label><input id="editPre" type="number" oninput="calcAndUpdateEditRoast()"></div>
    <div class="form-row"><label>焙煎後(g)</label><input id="editPost" type="number" oninput="calcAndUpdateEditRoast()"></div>
    <div class="form-row"><label>焙煎度</label><input id="editLevel" type="text" readonly></div>
    <div class="form-row"><label>コメント</label><textarea id="editComment" rows="4"></textarea></div>
    <div style="text-align:right;"><button id="editSave">保存</button></div>
  </div>
</div>

</div>

<!-- フッター -->
<footer>
  <a id="privacy-link">プライバシーポリシー</a>
</footer>

<!-- モーダル -->
<div id="privacy-modal">
  <div class="modal-content">
    <span class="close" id="close-modal">×</span>
    <h2>プライバシーポリシー</h2>
    <p>当サイト「Coffee Roasting Log」（以下「当サイト」）では、ユーザーのプライバシーを尊重し、以下の方針に基づき運営しています。</p>
    <ol>
      <li>
        <strong>データの保存について</strong><br>
        当サイトでユーザーが入力する焙煎記録などのデータは、ブラウザの localStorage に保存され、サーバーには送信されません。<br>
        そのため、当サイト側で個人情報や記録を管理・収集することはありません。
      </li>
      <li>
        <strong>広告・アフィリエイトについて</strong><br>
        当サイトでは Google AdSense 等の広告サービスを利用しています。<br>
        広告配信事業者は Cookie 等を利用して、ユーザーの興味に基づいた広告を表示する場合があります。<br>
        また、当サイトはアフィリエイトプログラムに参加しており、リンク先の商品購入により報酬を得ることがあります。<br>
        広告やアフィリエイトにより収集される情報は、各サービス提供者のプライバシーポリシーに従います。
      </li>
      <li>
        <strong>クッキーについて</strong><br>
        当サイトでは、広告表示やアクセス解析のためにクッキーを利用する場合があります。<br>
        ブラウザ設定によりクッキーを無効化することも可能です。
      </li>
      <li>
        <strong>改定について</strong><br>
        本ポリシーは随時改定する場合があります。<br>
        改定後は当サイト上に掲載します。
      </li>
    </ol>
    <p><strong>【お問い合わせ】</strong><br>coffeegeek0809@gmail.com</p>
  </div>
</div>

<script>
  const modal = document.getElementById('privacy-modal');
  document.getElementById('privacy-link').onclick = () => {
    modal.style.display = 'flex';
  }
  document.getElementById('close-modal').onclick = () => {
    modal.style.display = 'none';
  }
  window.onclick = (e) => {
    if(e.target == modal) modal.style.display = 'none';
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let roastTimer=0, timerInterval=null;
  let temperatureLog=[], firstCrackTimes=[], secondCrackTimes=[], roastEndTime=null;
  let chart=null, historyLog=null;
  let editingId = null; // 編集対象の id

  function secToHMS(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function displayTimer(sec){ document.getElementById("timerDisplay").innerText = secToHMS(sec); }

  window.updateRoastLevel = function(){
    const pre=parseFloat(document.getElementById("preWeight").value);
    const post=parseFloat(document.getElementById("postWeight").value);
    if(pre>0 && post>0){
      const index=pre/post;
      let level="";
      if(index<1.15) level="浅煎り";
      else if(index<1.2) level="中煎り";
      else level="深煎り";
      document.getElementById("roastLevel").value=`${level}（${index.toFixed(3)}）`;
    }
  }

  // --- data sanity: 不完全な既存ログを補完 ---
  function ensureLogSanity(){
    const logs = JSON.parse(localStorage.getItem("roastLogs"))||[];
    let changed = false;
    for(let i=0;i<logs.length;i++){
      const l = logs[i];
      if(!l.id){ l.id = Date.now().toString() + '-' + Math.random().toString(36).slice(2,8); changed = true; }
      if(typeof l.favorite === 'undefined'){ l.favorite = false; changed = true; }
      if(!Array.isArray(l.temperatureLog)) { l.temperatureLog = l.temperatureLog || []; changed = true; }
      if(!Array.isArray(l.firstCrackTimes)) { l.firstCrackTimes = l.firstCrackTimes || []; changed = true; }
      if(!Array.isArray(l.secondCrackTimes)) { l.secondCrackTimes = l.secondCrackTimes || []; changed = true; }
      if(typeof l.roastEndTime === 'undefined') { l.roastEndTime = l.roastEndTime ?? null; changed = true; }
    }
    if(changed) localStorage.setItem("roastLogs", JSON.stringify(logs));
  }

  function populateFilterOptions(){
    ensureLogSanity();
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const beanSet=new Set(), yearSet=new Set(), monthSet=new Set();
    logs.forEach(log=>{
      beanSet.add(log.beanName);
      const d=new Date(log.roastDate);
      if(!isNaN(d)) {
        yearSet.add(d.getFullYear());
        monthSet.add(d.getMonth()+1);
      }
    });
    const beanSelect=document.getElementById("filterBean");
    const yearSelect=document.getElementById("filterYear");
    const monthSelect=document.getElementById("filterMonth");
    // いったんリセットしてから追加（重複防止）
    beanSelect.innerHTML = '<option value="">ALL</option>';
    yearSelect.innerHTML = '<option value="">ALL</option>';
    monthSelect.innerHTML = '<option value="">ALL</option>';
    Array.from(beanSet).sort().forEach(b=>{
      const opt=document.createElement("option");
      opt.value=b; opt.text=b; beanSelect.add(opt);
    });
    Array.from(yearSet).sort().forEach(y=>{
      const opt=document.createElement("option");
      opt.value=y; opt.text=y; yearSelect.add(opt);
    });
    Array.from(monthSet).sort().forEach(m=>{
      const opt=document.createElement("option");
      opt.value=m; opt.text=m; monthSelect.add(opt);
    });
  }

  // --- 表示（フィルタ適用） ---
  function displayHistory(){
    ensureLogSanity();
    const tbody=document.querySelector("#historyTable tbody");
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const beanFilter=document.getElementById("filterBean").value;
    const yearFilter=document.getElementById("filterYear").value;
    const monthFilter=document.getElementById("filterMonth").value;
    const levelFilter=document.getElementById("filterLevel").value;

    const filteredLogs=logs.filter(log=>{
      const d=new Date(log.roastDate);
      const roastYear=d.getFullYear();
      const roastMonth=d.getMonth()+1;
      const roastLevel=log.roastLevel?log.roastLevel.split("（")[0]:"";
      if(beanFilter && log.beanName!==beanFilter) return false;
      if(yearFilter && roastYear!==parseInt(yearFilter)) return false;
      if(monthFilter && roastMonth!==parseInt(monthFilter)) return false;
      if(levelFilter && roastLevel!==levelFilter) return false;
      return true;
    });

    tbody.innerHTML="";
    filteredLogs.forEach((log)=>{
      const tr=document.createElement("tr");
      const star = log.favorite ? "★" : "☆";
      tr.innerHTML=`
        <td class="favorite-cell" data-id="${log.id}">${star}</td>
        <td class="operation-col">
          <button class="edit-btn" data-id="${log.id}" title="編集">✏</button>
          <button class="delete-btn" data-id="${log.id}" title="削除">🗑</button>
        </td>
        <td>${log.beanName}</td>
        <td>${log.roastDate}</td>
        <td>${log.inputTemp ?? ''}</td>
        <td>${log.preWeight ?? ''}</td>
        <td>${log.postWeight ?? ''}</td>
        <td>${log.roastLevel ?? ''}</td>
        <td>${(log.firstCrackTimes||[]).map(secToHMS).join(', ')}</td>
        <td>${(log.secondCrackTimes||[]).map(secToHMS).join(', ')}</td>
        <td>${log.roastEndTime!==null && log.roastEndTime!==undefined?secToHMS(log.roastEndTime):''}</td>
        <td class="comment-col">${log.comment ?? ''}</td>
      `;
      tr.addEventListener('click', ()=>{ historyLog = log; document.getElementById("historyLabel").innerText = "■ 履歴参照中: " + log.beanName + " / " + log.roastDate; updateChart(); });
      tbody.appendChild(tr);
    });

    // --- attach events for newly created elements ---

    // お気に入り切替
    document.querySelectorAll(".favorite-cell").forEach(cell=>{
      cell.addEventListener("click",(e)=>{
        e.stopPropagation();
        const id = cell.dataset.id;
        const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
        const idxAll = logsAll.findIndex(l=>l.id === id);
        if(idxAll>=0){
          logsAll[idxAll].favorite = !logsAll[idxAll].favorite;
          localStorage.setItem("roastLogs", JSON.stringify(logsAll));
          populateFilterOptions();
          displayHistory();
        }
      });
    });

    // コメント列クリックでモーダル
    document.querySelectorAll("#historyTable td.comment-col").forEach(td=>{
      td.addEventListener("click",(e)=>{
        e.stopPropagation();
        const tr = td.parentElement;
        const bean = tr.cells[2].innerText;
        const date = tr.cells[3].innerText;
        const level = tr.cells[7].innerText;
        document.getElementById("modalText").innerText = td.innerText;
        document.getElementById("modalTitle").innerText = `${bean} / ${date} / ${level}`;
        document.getElementById("commentModal").style.display = "block";
      });
    });

    // 編集ボタン
    document.querySelectorAll(".edit-btn").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        const id = btn.dataset.id;
        const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
        const idxAll = logsAll.findIndex(l=>l.id === id);
        if(idxAll<0) return;
        const record = logsAll[idxAll];
        editingId = id;
        document.getElementById("editBean").value = record.beanName || "";
        document.getElementById("editDate").value = record.roastDate || "";
        document.getElementById("editTemp").value = record.inputTemp ?? "";
        document.getElementById("editPre").value = record.preWeight ?? "";
        document.getElementById("editPost").value = record.postWeight ?? "";
        document.getElementById("editLevel").value = record.roastLevel || "";
        document.getElementById("editComment").value = record.comment || "";
        document.getElementById("editModal").style.display = "block";
      });
    });

    // 削除ボタン
    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        const id = btn.dataset.id;
        if(!confirm("この記録を削除しますか？")) return;
        const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
        const idxAll = logsAll.findIndex(l=>l.id === id);
        if(idxAll>=0){
          logsAll.splice(idxAll,1);
          localStorage.setItem("roastLogs", JSON.stringify(logsAll));
          populateFilterOptions();
          displayHistory();
        }
      });
    });

  } // displayHistory end

  // --- モーダル：閉じる（共通） ---
  document.getElementById("closeCommentModal").addEventListener("click", ()=>{ document.getElementById("commentModal").style.display = "none"; });
  document.getElementById("editClose").addEventListener("click", ()=>{ document.getElementById("editModal").style.display = "none"; });

  // 背景クリックで閉じる（両モーダルに対応）
  window.addEventListener("click", (event)=>{
    const cm = document.getElementById("commentModal");
    const em = document.getElementById("editModal");
    if(event.target === cm) cm.style.display = "none";
    if(event.target === em) em.style.display = "none";
  });

// 共通計算＆更新関数
function calcAndUpdateEditRoast() {
  const pre = parseFloat(document.getElementById("editPre").value);
  const post = parseFloat(document.getElementById("editPost").value);

  if(pre > 0 && post > 0){
    const roastIndex = pre / post;
    let roastLevel = "";
    if(roastIndex < 1.15) roastLevel = "浅煎り";
    else if(roastIndex < 1.2) roastLevel = "中煎り";
    else roastLevel = "深煎り";

    // モーダル表示用
    document.getElementById("editLevel").value = `${roastLevel}（${roastIndex.toFixed(3)}）`;

    return { roastIndex, roastLevel: `${roastLevel}（${roastIndex.toFixed(3)}）` };
  } else {
    document.getElementById("editLevel").value = "";
    return { roastIndex: null, roastLevel: "" };
  }
}

// モーダル入力欄のoninputでリアルタイム更新
document.getElementById("editPre").addEventListener("input", calcAndUpdateEditRoast);
document.getElementById("editPost").addEventListener("input", calcAndUpdateEditRoast);

// 保存ボタン処理
document.getElementById("editSave").addEventListener("click", ()=> {
  if(!editingId){ alert("編集対象が不明です"); return; }
  const logsAll = JSON.parse(localStorage.getItem("roastLogs"))||[];
  const idxAll = logsAll.findIndex(l=>l.id === editingId);
  if(idxAll<0){ alert("対象が見つかりません"); return; }

  const pre = parseFloat(document.getElementById("editPre").value);
  const post = parseFloat(document.getElementById("editPost").value);

  // 計算関数で焙煎指数と度合を取得
  const { roastIndex, roastLevel } = calcAndUpdateEditRoast();

  // 保存
  logsAll[idxAll] = {
    ...logsAll[idxAll],
    beanName: document.getElementById("editBean").value,
    roastDate: document.getElementById("editDate").value,
    inputTemp: parseFloat(document.getElementById("editTemp").value) || null,
    preWeight: pre || null,
    postWeight: post || null,
    roastIndex,
    roastLevel,
    comment: document.getElementById("editComment").value
  };

  localStorage.setItem("roastLogs", JSON.stringify(logsAll));
  populateFilterOptions();
  displayHistory();
  document.getElementById("editModal").style.display = "none";
});



  // --- 既存の処理（タイマー・記録追加等） ---
  function startTimer(){
    temperatureLog = [];
    firstCrackTimes = [];
    secondCrackTimes = [];
    roastEndTime = null;
    roastTimer = 0;
    displayTimer(roastTimer);
    updateTempLogDisplay();
    updateChart();
    const inputTemp = parseFloat(document.getElementById("inputTemp").value);
    if(!isNaN(inputTemp)) temperatureLog.push({time:roastTimer,temp:inputTemp,label:"投入"});
    if(timerInterval) return;
    timerInterval=setInterval(()=>{ roastTimer++; displayTimer(roastTimer); },1000);
  }
  function pauseTimer(){ clearInterval(timerInterval); timerInterval=null; }
  function resetTimer(){ clearInterval(timerInterval); roastTimer=0; temperatureLog=[]; firstCrackTimes=[]; secondCrackTimes=[]; roastEndTime=null; displayTimer(0); updateTempLogDisplay(); updateChart(); }
  function endTimer(){ pauseTimer(); roastEndTime=roastTimer; const temp=parseFloat(prompt("終了時の温度(℃)を入力してください","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"終了"}); updateTempLogDisplay(); updateChart(); }
  function markFirstCrack(){ const temp=parseFloat(prompt("1ハゼ時の温度(℃)を入力してください","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"1ハゼ"}); firstCrackTimes.push(roastTimer); updateTempLogDisplay(); updateChart(); }
  function markSecondCrack(){ const temp=parseFloat(prompt("2ハゼ時の温度(℃)を入力してください","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"2ハゼ"}); secondCrackTimes.push(roastTimer); updateTempLogDisplay(); updateChart(); }

  function addTemperature() {
    const temp = parseFloat(document.getElementById("tempInput").value);
    if(!isNaN(temp)){
      temperatureLog.push({time: roastTimer, temp, label: "手動"});
      document.getElementById("tempInput").value = "";
      updateTempLogDisplay();
      updateChart();
    }
  }

  function updateTempLogDisplay(){
    document.getElementById("tempLogDisplay").innerText=
      temperatureLog.map(t=>t.label?`${secToHMS(t.time)}:${t.temp}℃ (${t.label})`:`${secToHMS(t.time)}:${t.temp}℃`).join(', ');
  }

  function updateChart(){
    const ctx=document.getElementById("tempChart").getContext('2d');
    if(chart) chart.destroy();

    const currentData = temperatureLog.map(t=>({x:t.time,y:t.temp}));
    let datasets=[{
      label:'今回の焙煎',
      data: currentData,
      borderColor:'#a67c52',
      backgroundColor:'rgba(166,124,82,0.2)',
      tension:0.1,
      parsing:false,
      pointBackgroundColor: temperatureLog.map(t=>{
        if(t.label==='投入') return '#8b4513';
        if(t.label==='1ハゼ') return 'green';
        if(t.label==='2ハゼ') return 'blue';
        if(t.label==='終了') return '#5a3e2b';
        return '#a67c52';
      })
    }];

    if(historyLog && Array.isArray(historyLog.temperatureLog)){
      const historyData = historyLog.temperatureLog.map(t=>({x:t.time,y:t.temp}));
      datasets.push({
        label:'比較対象の焙煎',
        data: historyData,
        borderColor:'#ccc',
        backgroundColor:'rgba(200,200,200,0.2)',
        tension:0.1,
        parsing:false,
        pointRadius:2
      });
    }

    let annotations={};
    firstCrackTimes.forEach((t,i)=>{ annotations['f'+i]={type:'line', scaleID:'x', value:t, borderColor:'green', borderWidth:2,label:{display:true, content:'1ハゼ', color:'#fff', backgroundColor:'green', position:'start', rotation:0}}; });
    secondCrackTimes.forEach((t,i)=>{ annotations['s'+i]={type:'line', scaleID:'x', value:t, borderColor:'blue', borderWidth:2,label:{display:true, content:'2ハゼ', color:'#fff', backgroundColor:'blue', position:'start', rotation:0}}; });
    if(roastEndTime!==null) annotations['end']={type:'line', scaleID:'x', value:roastEndTime, borderColor:'#5a3e2b', borderWidth:2,label:{display:true, content:'終了', color:'#fff', backgroundColor:'#5a3e2b', position:'start', rotation:0}};
    if(historyLog){
      (historyLog.firstCrackTimes||[]).forEach((t,i)=>{ annotations['hf'+i]={type:'line', scaleID:'x', value:t, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'1ハゼ', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}}; });
      (historyLog.secondCrackTimes||[]).forEach((t,i)=>{ annotations['hs'+i]={type:'line', scaleID:'x', value:t, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'2ハゼ', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}}; });
      if(historyLog.roastEndTime!==null) annotations['hend']={type:'line', scaleID:'x', value:historyLog.roastEndTime, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'終了', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}};
    }

    chart=new Chart(ctx,{
      type:'line',
      data:{datasets},
      options:{
        scales:{ x:{ type:'linear', title:{display:true,text:'時間'} }, y:{ title:{display:true,text:'温度(℃)'} } },
        plugins:{ legend:{ display:true }, annotation:{ annotations } }
      }
    });
  }

  // 保存時に一意の id と favorite を付与して保存（温度ログ等は deep copy）
  function saveRoast(){
    const beanName=document.getElementById("beanName").value;
    const roastDate=document.getElementById("roastDate").value;
    const inputTemp=parseFloat(document.getElementById("inputTemp").value);
    const preWeight=parseFloat(document.getElementById("preWeight").value);
    const postWeight=parseFloat(document.getElementById("postWeight").value);
    const roastLevel=document.getElementById("roastLevel").value;
    const comment=document.getElementById("comment").value;
    if(!beanName || !roastDate || !preWeight || !postWeight){ alert("必須項目を入力してください"); return; }
    const roastIndex=preWeight/postWeight;
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const newId = Date.now().toString() + '-' + Math.random().toString(36).slice(2,8);
    // deep copy for arrays so later edits don't mutate saved record's arrays via reference
    const tempLogCopy = JSON.parse(JSON.stringify(temperatureLog || []));
    const fctCopy = JSON.parse(JSON.stringify(firstCrackTimes || []));
    const sctCopy = JSON.parse(JSON.stringify(secondCrackTimes || []));
    logs.push({
      id: newId,
      beanName, roastDate, inputTemp, preWeight, postWeight, roastIndex, roastLevel, comment,
      temperatureLog: tempLogCopy, firstCrackTimes: fctCopy, secondCrackTimes: sctCopy, roastEndTime,
      favorite: false
    });
    localStorage.setItem("roastLogs",JSON.stringify(logs));
    populateFilterOptions();
    displayHistory();
    alert("保存しました");
  }

  // HTMLエスケープ（表示安全）
  function escapeHtml(str){
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // イベント登録
  document.getElementById("startBtn").addEventListener("click", startTimer);
  document.getElementById("pauseBtn").addEventListener("click", pauseTimer);
  document.getElementById("resetBtn").addEventListener("click", resetTimer);
  document.getElementById("firstCrackBtn").addEventListener("click", markFirstCrack);
  document.getElementById("secondCrackBtn").addEventListener("click", markSecondCrack);
  document.getElementById("endBtn").addEventListener("click", endTimer);
  document.getElementById("addTempBtn").addEventListener("click", addTemperature);
  document.getElementById("saveBtn").addEventListener("click", saveRoast);

  // フィルターボタン
  document.getElementById("filterBtn").addEventListener("click", displayHistory);

  // 初期化
  populateFilterOptions();
  //　displayHistory(); // 初回表示（不要ならコメントアウトしてください）

// DOMContentLoaded 内に追加

// CSV出力関数
function exportCSV() {
  const logs = JSON.parse(localStorage.getItem("roastLogs")) || [];
  if(logs.length === 0){ alert("保存データがありません"); return; }

  const headers = ["お気に入り","豆名","焙煎日","焙煎度","焙煎前重量","焙煎後重量","投入温度","1ハゼ","2ハゼ","終了時間","温度ログ","コメント"];
  
  const rows = logs.map(log => {
    const firstCrack = (log.firstCrackTimes||[]).map(formatMMSS).join(";");
    const secondCrack = (log.secondCrackTimes||[]).map(formatMMSS).join(";");
    const tempLog = (log.temperatureLog||[])
      .map(t => `${formatMMSS(t.time)}:${t.temp}℃${t.label?`(${t.label})`:''}`)
      .join(", ");
    return [
      log.favorite?"★":"☆",
      log.beanName || "",
      log.roastDate || "",
      log.roastLevel || "",
      log.preWeight ?? "",
      log.postWeight ?? "",
      log.inputTemp ?? "",
      firstCrack,
      secondCrack,
      log.roastEndTime!==null && log.roastEndTime!==undefined ? formatMMSS(log.roastEndTime) : '',
      tempLog,
      log.comment ?? ""
    ].map(v => `"${v}"`).join(",");
  });

  const bom = "\uFEFF";
  const csvContent = bom + [headers.join(","), ...rows].join("\r\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  a.download = `roast_log_${yyyy}-${mm}-${dd}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}


// 秒を mm:ss に変換
function formatMMSS(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// CSV出力ボタンイベント
document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);


}); // DOMContentLoaded end
</script>
</body>
</html>

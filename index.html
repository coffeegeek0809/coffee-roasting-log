<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coffee Roast Log</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#f3ebe0; display:flex; flex-direction:column; align-items:center; }
.container { max-width:900px; width:100%; padding:20px; background:#fff8f0; margin:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1,h3 { color:#5a3e2b; text-align:center; }
label { font-weight:bold; color:#5a3e2b; display:flex; flex-direction:column; }
input, button, textarea, select { margin:5px 0; padding:8px; width: 100%; box-sizing: border-box; border-radius:5px; border:1px solid #ccc; }
textarea { height:50px; }
#timerDisplay { font-size:2em; font-weight:bold; margin: 10px 0; text-align:center; color:#d2691e; }
button { cursor:pointer; background:#8b4513; color:white; border:none; border-radius:5px; }
button:hover { background:#a0522d; }
#roastForm { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
#roastForm label { flex:1 1 45%; min-width:200px; }
#timerControls { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-bottom:10px; }
#timerControls button { flex: 1 1 40%; margin:5px; min-width:120px; padding:10px; }
#filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 15px;
    margin-bottom: 15px;
    align-items: center;
    justify-content: right;
    font-size: small;
}
#filters label {
    display: flow;
    align-items: center;
    gap: 5px;
    font-weight: bold;
    color: #5a3e2b;
}
#filters select {
    width: 55pt;
    font-size: x-small;
    text-align: left ;
}
table { border-collapse: collapse; width: 100%; margin-top:10px; overflow-x:auto; display:block; background:#fff8f0; }
th, td { border: 1px solid #ccc; padding:5px; text-align: center; white-space: nowrap; }
tr:hover { background-color: #f0e6dc; cursor:pointer; }
#tempChart { margin-top:10px; background:white; padding:10px; border-radius:8px; box-shadow:0 0 5px #ccc; }
#tempLogDisplay { margin-top:5px; font-size:0.9em; color:#5a3e2b; }

/* 温度記録 横並び */
.temp-input-container {
    display: flex;
    align-items: center;
    justify-content: right;
    gap: 10px;
    margin-top: 10px;
    font-size: small;
}
.temp-input-container label { font-weight: bold; color: #5a3e2b; min-width: fit-content; text-align: center; }
.temp-input-container input { width: fit-content; font-size: x-small; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
.temp-input-container button { width: 150px; padding: 8px; background-color: #8B4513; color: white; border: none; border-radius: 6px; cursor: pointer; }

#button { display: flex; flex-wrap: wrap; gap: 10pt; justify-content: right; }
#filterBtn { width: 70pt; font-size: x-small; }
#addTempBtn { width: 70pt;  font-size: x-small; }

/* 親 div をフレックスにして中央揃え */
.table-container { display: flex; justify-content: center; overflow-x: auto; }
/* テーブル自体は自動幅 */
#historyTable {
    border-collapse: collapse;
    width: auto;
    background: #fff8f0;
    font-size: small;
}

#historyTable thead {
    background-color: #d6bfae; /* お好みの色に変更 */
    color: #5a3e2b;            /* 文字色も変更可能 */
}

/* セル文字を左寄せ */
#historyTable th, #historyTable td { text-align: left; padding: 5px; border: 1px solid #ccc; }

/* 初期状態：省略表示 */
#historyTable th:last-child,
#historyTable td:last-child {
    max-width: 200px;       /* 最大幅 */
    overflow: hidden;       /* はみ出しを隠す */
    text-overflow: ellipsis;/* はみ出し部分を「…」で表示 */
    white-space: nowrap;    /* 改行をさせない */
    cursor: pointer;        /* クリックできることを示す */
}


/* モーダル全体（画面を覆う） */
.modal {
  display: none; /* 初期は非表示 */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5); /* 半透明背景 */
}

/* モーダル内容 */
.modal-content {
  background-color: #fff8f0;
  margin: 10% auto;
  padding: 20px;
  border-radius: 10px;
  width: 80%;
  max-width: 500px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.modal-content p {
    white-space: pre-wrap;   /* 折り返し＆改行を保持 */
    word-wrap: break-word;   /* 単語の途中でも折り返す */
}
.modal-title {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 10px;
    color: #5a3e2b;
}

/* 閉じるボタン */
.close {
  color: #aaa;
  float: right;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover { color: #000; }


</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
</head>
<body>
<div class="container">
<h1>Coffee Roast Log</h1>

<h3>基本情報</h3>
<div id="roastForm">
  <label>豆の名前:<input id="beanName" type="text"></label>
  <label>焙煎日:<input id="roastDate" type="date"></label>
  <label>投入温度(℃):<input id="inputTemp" type="number"></label>
  <label>焙煎前重量(g):<input id="preWeight" type="number"></label>
  <label>焙煎後重量(g):<input id="postWeight" type="number" oninput="updateRoastLevel()"></label>
  <label>焙煎度合:<input id="roastLevel" type="text" readonly></label>
  <label>コメント:<textarea id="comment"></textarea></label>
</div>

<h3>タイマー</h3>
<div id="timerDisplay">00:00:00</div>
<div id="timerControls">
  <button id="startBtn">開始</button>
  <button id="pauseBtn">一時停止</button>
  <button id="firstCrackBtn">1ハゼ</button>
  <button id="secondCrackBtn">2ハゼ</button>
  <button id="resetBtn">リセット(タイマー/グラフ)</button>
  <button id="endBtn">終了</button>
  <button id="saveBtn">焙煎記録を保存する</button>
</div>

<div class="section">
    <h3>温度管理</h3>
    <div class="temp-input-container">
      　<label id="historyLabel" >■ 履歴参照: なし</label>
        <label for="tempInput">■ 温度:</label>
        <input type="number" id="tempInput" placeholder="温度を入力してください">
        <button id="addTempBtn">記録</button>
    </div>
<div id="tempLogDisplay"></div>
<canvas id="tempChart"></canvas>
</div>

<h3>焙煎記録</h3>
<div id="button">
    <button id="filterBtn">記録を表示</button>
</div>
<div id="filters">
  <label>豆：
    <select id="filterBean"><option value="">ALL</option></select>
  </label>
  <label>焙煎年：
    <select id="filterYear"><option value="">ALL</option></select>
  </label>
  <label>焙煎月：
    <select id="filterMonth"><option value="">ALL</option></select>
  </label>
  <label>焙煎度：
    <select id="filterLevel">
      <option value="">ALL</option>
      <option value="浅煎り">浅煎り</option>
      <option value="中煎り">中煎り</option>
      <option value="深煎り">深煎り</option>
    </select>
  </label>
</div>

<div class="table-container">
  <table id="historyTable">
    <thead>
      <tr>
        <th>豆</th><th>焙煎日</th><th>投入温度(℃)</th><th>焙煎前(g)</th><th>焙煎後(g)</th>
        <th>焙煎度</th><th>1ハゼ</th><th>2ハゼ</th><th>所要時間</th><th>コメント(クリックで全体を表示)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- コメント表示用モーダル -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="modal-title" id="modalTitle"></div> <!-- 追加 -->
    <p id="modalText"></p>
  </div>
</div>


</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let roastTimer=0, timerInterval=null;
  let temperatureLog=[], firstCrackTimes=[], secondCrackTimes=[], roastEndTime=null;
  let chart=null, historyLog=null;

  function secToHMS(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function displayTimer(sec){ document.getElementById("timerDisplay").innerText = secToHMS(sec); }

  window.updateRoastLevel = function(){
    const pre=parseFloat(document.getElementById("preWeight").value);
    const post=parseFloat(document.getElementById("postWeight").value);
    if(pre>0 && post>0){
      const index=pre/post;
      let level="";
      if(index<1.15) level="浅煎り";
      else if(index<1.2) level="中煎り";
      else level="深煎り";
      document.getElementById("roastLevel").value=`${level}（${index.toFixed(3)}）`;
    }
  }

  function populateFilterOptions(){
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const beanSet=new Set(), yearSet=new Set(), monthSet=new Set();
    logs.forEach(log=>{
      beanSet.add(log.beanName);
      const d=new Date(log.roastDate);
      yearSet.add(d.getFullYear());
      monthSet.add(d.getMonth()+1);
    });
    const beanSelect=document.getElementById("filterBean");
    const yearSelect=document.getElementById("filterYear");
    const monthSelect=document.getElementById("filterMonth");
    beanSet.forEach(b=>{ if(!Array.from(beanSelect.options).some(o=>o.value===b)){ const opt=document.createElement("option"); opt.value=b; opt.text=b; beanSelect.add(opt); } });
    Array.from(yearSet).sort().forEach(y=>{ if(!Array.from(yearSelect.options).some(o=>o.value==y)){ const opt=document.createElement("option"); opt.value=y; opt.text=y; yearSelect.add(opt); } });
    Array.from(monthSet).sort().forEach(m=>{ if(!Array.from(monthSelect.options).some(o=>o.value==m)){ const opt=document.createElement("option"); opt.value=m; opt.text=m; monthSelect.add(opt); } });
  }

  function displayHistory(){

    const tbody=document.querySelector("#historyTable tbody");
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    const beanFilter=document.getElementById("filterBean").value;
    const yearFilter=document.getElementById("filterYear").value;
    const monthFilter=document.getElementById("filterMonth").value;
    const levelFilter=document.getElementById("filterLevel").value;

    const filteredLogs=logs.filter(log=>{
      const d=new Date(log.roastDate);
      const roastYear=d.getFullYear();
      const roastMonth=d.getMonth()+1;
      const roastLevel=log.roastLevel.split("（")[0];
      if(beanFilter && log.beanName!==beanFilter) return false;
      if(yearFilter && roastYear!==parseInt(yearFilter)) return false;
      if(monthFilter && roastMonth!==parseInt(monthFilter)) return false;
      if(levelFilter && roastLevel!==levelFilter) return false;
      return true;
    });

    tbody.innerHTML="";
    filteredLogs.forEach(log=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${log.beanName}</td>
        <td>${log.roastDate}</td>
        <td>${log.inputTemp}</td>
        <td>${log.preWeight}</td>
        <td>${log.postWeight}</td>
        <td>${log.roastLevel}</td>
        <td>${log.firstCrackTimes.map(secToHMS).join(', ')}</td>
        <td>${log.secondCrackTimes.map(secToHMS).join(', ')}</td>
        <td>${log.roastEndTime!==null?secToHMS(log.roastEndTime):''}</td>
        <td>${log.comment}</td>
      `;
      tr.onclick=()=>{ historyLog=log; document.getElementById("historyLabel").innerText = "■ 履歴参照中: " + log.beanName + " / " + log.roastDate; updateChart(); };
      tbody.appendChild(tr);
    });

document.querySelectorAll("#historyTable td:last-child").forEach(td => {
    td.addEventListener("click", () => {
        // コメントをモーダルにセット
        document.getElementById("modalText").innerText = td.innerText;

        // モーダルタイトルに豆情報・焙煎日・焙煎度を表示
        const tr = td.parentElement;
        const bean = tr.cells[0].innerText;
        const date = tr.cells[1].innerText;
        const level = tr.cells[5].innerText;
        document.getElementById("modalTitle").innerText = `${bean} / ${date} / ${level}`;

        // モーダル表示
        document.getElementById("commentModal").style.display = "block";
    });
});


// 閉じるボタン
document.querySelector(".close").addEventListener("click", () => {
    document.getElementById("commentModal").style.display = "none";
});

// モーダル背景クリックでも閉じる
window.addEventListener("click", (event) => {
    const modal = document.getElementById("commentModal");
    if(event.target === modal){
        modal.style.display = "none";
    }
});


  }

  document.getElementById("filterBtn").addEventListener("click", displayHistory);
  populateFilterOptions();

  function startTimer(){
    temperatureLog = [];
    firstCrackTimes = [];
    secondCrackTimes = [];
    roastEndTime = null;
    roastTimer = 0;
    displayTimer(roastTimer);
    updateTempLogDisplay();
    updateChart();
    const inputTemp = parseFloat(document.getElementById("inputTemp").value);
    if(!isNaN(inputTemp)) temperatureLog.push({time:roastTimer,temp:inputTemp,label:"投入"});
    if(timerInterval) return;
    timerInterval=setInterval(()=>{ roastTimer++; displayTimer(roastTimer); },1000);
  }
  function pauseTimer(){ clearInterval(timerInterval); timerInterval=null; }
  function resetTimer(){ clearInterval(timerInterval); roastTimer=0; temperatureLog=[]; firstCrackTimes=[]; secondCrackTimes=[]; roastEndTime=null; displayTimer(0); updateTempLogDisplay(); updateChart(); }
  function endTimer(){ pauseTimer(); roastEndTime=roastTimer; const temp=parseFloat(prompt("終了時の温度(℃)を入力してください","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"終了"}); updateTempLogDisplay(); updateChart(); }
  function markFirstCrack(){ const temp=parseFloat(prompt("1ハゼ時の温度(℃)を入力してください","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"1ハゼ"}); firstCrackTimes.push(roastTimer); updateTempLogDisplay(); updateChart(); }
  function markSecondCrack(){ const temp=parseFloat(prompt("2ハゼ時の温度(℃)を入力してください","")); if(!isNaN(temp)) temperatureLog.push({time:roastTimer,temp,label:"2ハゼ"}); secondCrackTimes.push(roastTimer); updateTempLogDisplay(); updateChart(); }

  // --- ここが修正版 ---
  function addTemperature() {
    const temp = parseFloat(document.getElementById("tempInput").value);
    if(!isNaN(temp)){
      temperatureLog.push({time: roastTimer, temp, label: "手動"});
      document.getElementById("tempInput").value = "";
      updateTempLogDisplay();
      updateChart();
    }
  }

  function updateTempLogDisplay(){
    document.getElementById("tempLogDisplay").innerText=
      temperatureLog.map(t=>t.label?`${secToHMS(t.time)}:${t.temp}℃ (${t.label})`:`${secToHMS(t.time)}:${t.temp}℃`).join(', ');
  }

  function updateChart(){
    const ctx=document.getElementById("tempChart").getContext('2d');
    if(chart) chart.destroy();

    const currentData = temperatureLog.map(t=>({x:t.time,y:t.temp}));
    let datasets=[{
      label:'今回の温度(℃)',
      data: currentData,
      borderColor:'#a67c52',
      backgroundColor:'rgba(166,124,82,0.2)',
      tension:0.1,
      parsing:false,
      pointBackgroundColor: temperatureLog.map(t=>{
        if(t.label==='投入') return '#8b4513';
        if(t.label==='1ハゼ') return 'green';
        if(t.label==='2ハゼ') return 'blue';
        if(t.label==='終了') return '#5a3e2b';
        return '#a67c52';
      })
    }];

    if(historyLog){
      const historyData = historyLog.temperatureLog.map(t=>({x:t.time,y:t.temp}));
      datasets.push({
        label:'履歴温度(℃)',
        data: historyData,
        borderColor:'#ccc',
        backgroundColor:'rgba(200,200,200,0.2)',
        tension:0.1,
        parsing:false,
        pointRadius:2
      });
    }

    let annotations={};
    firstCrackTimes.forEach((t,i)=>{ annotations['f'+i]={type:'line', scaleID:'x', value:t, borderColor:'green', borderWidth:2,label:{display:true, content:'1ハゼ', color:'#fff', backgroundColor:'green', position:'start', rotation:0}}; });
    secondCrackTimes.forEach((t,i)=>{ annotations['s'+i]={type:'line', scaleID:'x', value:t, borderColor:'blue', borderWidth:2,label:{display:true, content:'2ハゼ', color:'#fff', backgroundColor:'blue', position:'start', rotation:0}}; });
    if(roastEndTime!==null) annotations['end']={type:'line', scaleID:'x', value:roastEndTime, borderColor:'#5a3e2b', borderWidth:2,label:{display:true, content:'終了', color:'#fff', backgroundColor:'#5a3e2b', position:'start', rotation:0}};
    if(historyLog){
      historyLog.firstCrackTimes.forEach((t,i)=>{ annotations['hf'+i]={type:'line', scaleID:'x', value:t, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'1ハゼ', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}}; });
      historyLog.secondCrackTimes.forEach((t,i)=>{ annotations['hs'+i]={type:'line', scaleID:'x', value:t, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'2ハゼ', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}}; });
      if(historyLog.roastEndTime!==null) annotations['hend']={type:'line', scaleID:'x', value:historyLog.roastEndTime, borderColor:'#aaa', borderWidth:1, label:{display:true, content:'終了', color:'#fff', backgroundColor:'#aaa', position:'start', rotation:0}};
    }

    chart=new Chart(ctx,{
      type:'line',
      data:{datasets},
      options:{
        scales:{ x:{ type:'linear', title:{display:true,text:'時間'} }, y:{ title:{display:true,text:'温度(℃)'} } },
        plugins:{ legend:{ display:true }, annotation:{ annotations } }
      }
    });
  }
  function saveRoast(){
    const beanName=document.getElementById("beanName").value;
    const roastDate=document.getElementById("roastDate").value;
    const inputTemp=parseFloat(document.getElementById("inputTemp").value);
    const preWeight=parseFloat(document.getElementById("preWeight").value);
    const postWeight=parseFloat(document.getElementById("postWeight").value);
    const roastLevel=document.getElementById("roastLevel").value;
    const comment=document.getElementById("comment").value;
    if(!beanName || !roastDate || !preWeight || !postWeight){ alert("必須項目を入力してください"); return; }
    const roastIndex=preWeight/postWeight;
    const logs=JSON.parse(localStorage.getItem("roastLogs"))||[];
    logs.push({beanName,roastDate,inputTemp,preWeight,postWeight,roastIndex,roastLevel,comment,temperatureLog,firstCrackTimes,secondCrackTimes,roastEndTime});
    localStorage.setItem("roastLogs",JSON.stringify(logs));
    populateFilterOptions();
    displayHistory();
    alert("保存しました");
  }
  // --- タイマー & クラックボタン ---
  document.getElementById("startBtn").addEventListener("click", startTimer);
  document.getElementById("pauseBtn").addEventListener("click", pauseTimer);
  document.getElementById("resetBtn").addEventListener("click", resetTimer);
  document.getElementById("firstCrackBtn").addEventListener("click", markFirstCrack);
  document.getElementById("secondCrackBtn").addEventListener("click", markSecondCrack);
  document.getElementById("endBtn").addEventListener("click", endTimer);
  document.getElementById("addTempBtn").addEventListener("click", addTemperature);
  document.getElementById("saveBtn").addEventListener("click",saveRoast);
  

});
</script>
</body>
</html>
